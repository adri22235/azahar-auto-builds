name: Build Windows (Manual)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag/branch to build'
        required: true
        default: '2125'

jobs:
  windows-build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        target: ["msvc", "msys2"]
    defaults:
      run:
        shell: ${{ (matrix.target == 'msys2' && 'msys2') || 'bash' }} {0}
    env:
      OS: windows
      TARGET: ${{ matrix.target }}
    steps:
      - name: Checkout Azahar
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          path: src
          submodules: recursive
          fetch-depth: 0

      - name: Set up MSVC
        if: ${{ matrix.target == 'msvc' }}
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install extra tools (MSVC)
        if: ${{ matrix.target == 'msvc' }}
        run: choco install ccache ninja ptime wget

      - name: Install vulkan-sdk (MSVC)
        if: ${{ matrix.target == 'msvc' }}
        run: |
          wget https://sdk.lunarg.com/sdk/download/1.3.296.0/windows/VulkanSDK-1.3.296.0-Installer.exe -O D:/a/_temp/vulkan.exe
          D:/a/_temp/vulkan.exe --accept-licenses --default-answer --confirm-command install

      - name: Set up MSYS2
        if: ${{ matrix.target == 'msys2' }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: clang64
          update: true
          install: git make p7zip
          pacboy: >-
            toolchain:p ccache:p cmake:p ninja:p spirv-tools:p
            qt6-base:p qt6-multimedia:p qt6-multimedia-wmf:p qt6-tools:p qt6-translations:p

      - name: Patch fmt and file_util for MSYS2
        if: ${{ matrix.target == 'msys2' }}
        run: |
          sed -i '1i#include <cstdlib>' src/externals/fmt/include/fmt/format.h
          sed -i '/namespace FileUtil/i #define stat _stat64\n#define fstat _fstat64' src/src/common/file_util.cpp

      - name: Install extra tools (MSYS2)
        if: ${{ matrix.target == 'msys2' }}
        uses: crazy-max/ghaction-chocolatey@v3
        with:
          args: install ptime wget

      - name: Build
        run: cd src && ./.ci/windows.sh

      - name: Create Installer
        shell: cmd
        run: |
          echo !include "MUI2.nsh" > installer.nsi
          echo Name "Azahar Emulator" >> installer.nsi
          echo OutFile "Azahar-Setup.exe" >> installer.nsi
          echo Unicode True >> installer.nsi
          echo InstallDir "$LOCALAPPDATA\Azahar" >> installer.nsi
          echo InstallDirRegKey HKCU "Software\Azahar" "" >> installer.nsi
          echo RequestExecutionLevel user >> installer.nsi
          echo !define MUI_ABORTWARNING >> installer.nsi
          echo !define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico" >> installer.nsi
          echo !insertmacro MUI_PAGE_WELCOME >> installer.nsi
          echo !insertmacro MUI_PAGE_LICENSE "src\license.txt" >> installer.nsi
          echo !insertmacro MUI_PAGE_DIRECTORY >> installer.nsi
          echo !insertmacro MUI_PAGE_INSTFILES >> installer.nsi
          echo !insertmacro MUI_PAGE_FINISH >> installer.nsi
          echo !insertmacro MUI_UNPAGE_CONFIRM >> installer.nsi
          echo !insertmacro MUI_UNPAGE_INSTFILES >> installer.nsi
          echo !insertmacro MUI_LANGUAGE "English" >> installer.nsi
          echo Section "Azahar" SecAzahar >> installer.nsi
          echo   SetOutPath "$INSTDIR" >> installer.nsi
          echo   File /r "src\build\bundle\*" >> installer.nsi
          echo   WriteUninstaller "$INSTDIR\Uninstall.exe" >> installer.nsi
          echo   CreateDirectory "$SMPROGRAMS\Azahar" >> installer.nsi
          echo   CreateShortcut "$SMPROGRAMS\Azahar\Azahar.lnk" "$INSTDIR\azahar-qt.exe" >> installer.nsi
          echo   CreateShortcut "$SMPROGRAMS\Azahar\Uninstall.lnk" "$INSTDIR\Uninstall.exe" >> installer.nsi
          echo   WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Azahar" "DisplayName" "Azahar Emulator" >> installer.nsi
          echo   WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Azahar" "UninstallString" "$\"$INSTDIR\Uninstall.exe$\"" >> installer.nsi
          echo   WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Azahar" "DisplayIcon" "$INSTDIR\azahar-qt.exe" >> installer.nsi
          echo   WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Azahar" "Publisher" "Azahar Team" >> installer.nsi
          echo SectionEnd >> installer.nsi
          echo Section "Uninstall" >> installer.nsi
          echo   RMDir /r "$INSTDIR" >> installer.nsi
          echo   RMDir /r "$SMPROGRAMS\Azahar" >> installer.nsi
          echo   DeleteRegKey HKCU "Software\Azahar" >> installer.nsi
          echo   DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Azahar" >> installer.nsi
          echo SectionEnd >> installer.nsi
          
          makensis installer.nsi
          mkdir -p artifacts
          move Azahar-Setup.exe artifacts\Azahar-Setup-%TARGET%.exe

      - name: Pack
        run: cd src && ./.ci/pack.sh

      - name: Upload to Release
        run: |
          $TAG = "${{ github.event.inputs.tag }}"
          foreach ($file in Get-ChildItem artifacts/*) {
            gh release upload $TAG $file.FullName --repo adri22235/azahar-auto-builds --clobber
          }
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
