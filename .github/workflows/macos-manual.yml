name: Build macOS (Manual)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build'
        required: true
        default: '2125'

jobs:
  macos-build:
    runs-on: macos-latest
    steps:
      - name: Checkout Azahar
        uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: ${{ github.event.inputs.tag }}

      - name: Install dependencies
        run: brew install ccache ninja qt6

      - name: Patch Deployment Target
        run: |
          sed -i '' 's/set(CMAKE_OSX_DEPLOYMENT_TARGET "11.0")/set(CMAKE_OSX_DEPLOYMENT_TARGET "14.0")/g' CMakeLists.txt
          sed -i '' 's/find_package(Qt6 REQUIRED COMPONENTS Widgets Multimedia Concurrent)/find_package(Qt6 REQUIRED COMPONENTS Widgets Multimedia Concurrent Gui)/g' CMakeLists.txt

      - name: Build
        run: |
          mkdir build && cd build
          cmake .. -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_QT_TRANSLATION=ON \
            -DUSE_DISCORD_PRESENCE=ON \
            -DCMAKE_PREFIX_PATH=$(brew --prefix qt6) \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0
          ninja bundle
          mv bundle/azahar.app bundle/Azahar.app

      - name: Package
        run: |
          # Create a ZIP for the .app
          cd build/bundle
          zip -r ../../azahar-${{ github.event.inputs.tag }}-macos.zip Azahar.app

      - name: Upload to Release
        run: gh release upload ${{ github.event.inputs.tag }} azahar-${{ github.event.inputs.tag }}-macos.zip --repo adri22235/azahar-auto-builds || echo "Release not found or upload failed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
